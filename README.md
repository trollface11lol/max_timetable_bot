# Max Timetable Bot

–¢–µ–ª–µ–≥—Ä–∞–º‚Äë–±–æ—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –∑–∞–Ω—è—Ç–∏–π, –ø–æ–¥–ø–∏—Å–æ–∫ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è,
–µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö —Ä–∞—Å—Å—ã–ª–æ–∫ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ gRPC‚ÄëAPI.\
–ü—Ä–æ–µ–∫—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Docker‚Äë—Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ, –º–∏–≥—Ä–∞—Ü–∏–∏ Alembic, –∫—Ä–æ–Ω‚Äë–∑–∞–¥–∞—á–∏
–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å PostgreSQL.

------------------------------------------------------------------------

# –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

    max_timetable_bot/
    ‚îÇ
    ‚îú‚îÄ‚îÄ alembic.ini                # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Alembic
    ‚îú‚îÄ‚îÄ docker-compose.yml         # Docker‚Äë–æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è
    ‚îú‚îÄ‚îÄ Dockerfile                 # –°–±–æ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    ‚îú‚îÄ‚îÄ entrypoint.sh              # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ (–æ–∂–∏–¥–∞–Ω–∏–µ –ë–î + –º–∏–≥—Ä–∞—Ü–∏–∏ + –∑–∞–ø—É—Å–∫)
    ‚îú‚îÄ‚îÄ dump.sql                   # –ù–∞—á–∞–ª—å–Ω—ã–π SQL‚Äë–¥–∞–º–ø –¥–ª—è PostgreSQL
    ‚îú‚îÄ‚îÄ main.py                    # –ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª –∑–∞–ø—É—Å–∫–∞ Max‚Äë–±–æ—Ç–∞
    ‚îú‚îÄ‚îÄ requirements.txt           # Python‚Äë–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    ‚îÇ
    ‚îú‚îÄ‚îÄ migrations/                # Alembic –º–∏–≥—Ä–∞—Ü–∏–∏
    ‚îÇ   ‚îú‚îÄ‚îÄ env.py
    ‚îÇ   ‚îú‚îÄ‚îÄ script.py.mako
    ‚îÇ   ‚îî‚îÄ‚îÄ versions/              # –ê–≤—Ç–æ‚Äë–≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã–µ —Ä–µ–≤–∏–∑–∏–∏
    ‚îÇ
    ‚îú‚îÄ‚îÄ cronjobs/                  # –ö—Ä–æ–Ω‚Äë–ø—Ä–æ—Ü–µ—Å—Å—ã (–≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ)
    ‚îÇ   ‚îú‚îÄ‚îÄ main.py                # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –∫—Ä–æ–Ω‚Äë—Å–µ—Ä–≤–∏—Å–∞
    ‚îÇ   ‚îú‚îÄ‚îÄ daily_notifier.py      # –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ –≤ 8.30 —É—Ç—Ä–∞ —Å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º –Ω–∞ –¥–µ–Ω—å
    ‚îÇ   ‚îú‚îÄ‚îÄ updates_by_api.py      # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –∏ —Ä–∞—Å—Å—ã–ª–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    ‚îÇ   ‚îú‚îÄ‚îÄ subscribe_by_api.py    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ SQL-—Ñ–∞–π–ª–∞ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –±–æ–ª–µ–µ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏
    ‚îÇ   ‚îî‚îÄ‚îÄ __init__.py
    ‚îÇ
    ‚îú‚îÄ‚îÄ handlers/                  # Max‚Äë—Ö–µ–Ω–¥–ª–µ—Ä—ã
    ‚îÇ   ‚îú‚îÄ‚îÄ start_handler.py       # –°—Ç–∞—Ä—Ç–æ–≤—ã–π —Ö–µ–Ω–¥–ª–µ—Ä
    ‚îÇ   ‚îú‚îÄ‚îÄ daily_handler.py       # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–æ–π –≤ 8.30 —É—Ç—Ä–∞
    ‚îÇ   ‚îú‚îÄ‚îÄ schedule_handler.py    # –•–µ–Ω–¥–ª–µ—Ä, –ø–æ–∫–∞–∑—ã–≤–∞—é—â–∏–π –≤—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞
    ‚îÇ   ‚îú‚îÄ‚îÄ days_handler.py        # –ü–æ–∫–∞–∑ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è / –∑–∞–≤—Ç—Ä–∞ / –Ω–µ–¥–µ–ª—é
    ‚îÇ   ‚îú‚îÄ‚îÄ subscribe_handler.py   # –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∏–ø
    ‚îÇ   ‚îú‚îÄ‚îÄ unsubscribe_handler.py # –û—Ç–ø–∏—Å–∫–∞ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞
    ‚îÇ   ‚îî‚îÄ‚îÄ __init__.py
    ‚îÇ
    ‚îú‚îÄ‚îÄ db/                        # –ë–î‚Äë–ª–æ–≥–∏–∫–∞
    ‚îÇ   ‚îú‚îÄ‚îÄ db_tables.py           # SQLAlchemy –º–æ–¥–µ–ª–∏
    ‚îÇ   ‚îú‚îÄ‚îÄ db_operations.py       # –û–ø–µ—Ä–∞—Ü–∏–∏ —Å –ë–î
    ‚îÇ   ‚îú‚îÄ‚îÄ schedule-min-3.db      # –õ–æ–∫–∞–ª—å–Ω—ã–π SQLite
    ‚îÇ
    ‚îú‚îÄ‚îÄ grpc/                      # gRPC –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
    ‚îÇ   ‚îú‚îÄ‚îÄ personal-schedule.proto
    ‚îÇ   ‚îú‚îÄ‚îÄ personal_schedule_pb2.py
    ‚îÇ   ‚îú‚îÄ‚îÄ personal_schedule_pb2_grpc.py
    ‚îÇ   ‚îú‚îÄ‚îÄ schedule_client.py
    ‚îÇ
    ‚îî‚îÄ‚îÄ utils/                     # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã
        ‚îú‚îÄ‚îÄ detect.py              # –§—É–Ω–∫—Ü–∏—è –Ω–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –ø–æ–¥–ø–∏—Å–∫–∏
        ‚îú‚îÄ‚îÄ keyboards.py           # –ò–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
        ‚îú‚îÄ‚îÄ messaging.py           # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç —á–µ—Ä–µ–∑ HTTP
        ‚îî‚îÄ‚îÄ __init__.py

------------------------------------------------------------------------

# –û–ø–∏—Å–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

## **1. main.py**

–û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å Max‚Äë–±–æ—Ç–∞:\
--- –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è maxapi\
--- –∑–∞–≥—Ä—É–∑–∫–∞ —Ö–µ–Ω–¥–ª–µ—Ä–æ–≤\
--- –∑–∞–ø—É—Å–∫ polling

------------------------------------------------------------------------

## **2. handlers/**

–ö–∞—Ç–∞–ª–æ–≥ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ Max‚Äë–∫–æ–º–∞–Ω–¥:

  –§–∞–π–ª                       –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
  -------------------------- ----------------------------------------------
  `start_handler.py`         –ö–æ–º–∞–Ω–¥–∞ /start
  `schedule_handler.py`      –í—ã–≤–æ–¥ –≤—Å–µ—Ö –∏–º–µ—é—â–∏—Ö—Å—è –ø–æ–¥–ø–∏—Å–æ–∫ —É —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞
  `subscribe_handler.py`     –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
  `unsubscribe_handler.py`   –û—Ç–ø–∏—Å–∫–∞ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
  `daily_handler.py`         –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–º–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ –≤ 8.30 —É—Ç—Ä–∞
  `days_handler.py`          –ó–∞–ø—Ä–æ—Å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –Ω–∞ –¥–µ–Ω—å / –∑–∞–≤—Ç—Ä–∞ / –Ω–µ–¥–µ–ª—é

------------------------------------------------------------------------

## **3. cronjobs/**

–û—Ç–¥–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –≤—ã–ø–æ–ª–Ω—è—é—â–∏–π –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏:

  -----------------------------------------------------------------------
  –§–∞–π–ª                    –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
  ----------------------- -----------------------------------------------
  `daily_notifier.py`     –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –≤ 8.30 —É—Ç—Ä–∞

  `updates_by_api.py`     –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –ø–æ API –∏ —Ä–∞—Å—Å—ã–ª–∫–∞
                          —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏

  `subscribe_by_api.py`   –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                          —á–µ—Ä–µ–∑ API

  `main.py`               –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö –∫—Ä–æ–Ω–¥–∂–æ–±–æ–≤ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é

------------------------------------------------------------------------

## **4. db/**

–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã PostgreSQL –∏ SQLite:

  -----------------------------------------------------------------------
  –§–∞–π–ª                    –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
  ----------------------- -----------------------------------------------
  `db_tables.py`          SQLAlchemy‚Äë–º–æ–¥–µ–ª–∏ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–æ–∫, 
                          —Å–æ–≥–ª–∞—Å–∏–π –Ω–∞ —Ä–∞—Å—Å—ã–ª–∫–∏, –∏ —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ 
                          —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è (`max_subscribes`, `snapshot_info`)

  `db_operations.py`      –§—É–Ω–∫—Ü–∏–∏ –ø–æ —Ä–∞–±–æ—Ç–µ —Å –ë–î

  `schedule-min-3.db`     –õ–æ–∫–∞–ª—å–Ω—ã–π SQLite —Å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º

------------------------------------------------------------------------

## **5. migrations/**

Alembic‚Äë–º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è PostgreSQL.

–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ, –ø–æ—Å–ª–µ –ø–æ–¥–Ω—è—Ç–∏—è Docker:

    alembic upgrade head

–°–æ–∑–¥–∞—é—Ç—Å—è —Ç–∞–±–ª–∏—Ü—ã:

-   `max_subscribes`
-   `snapshot_info`

------------------------------------------------------------------------

## **6. grpc/**

gRPC‚Äë–∫–ª–∏–µ–Ω—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è:\
--- protobuf —Å—Ö–µ–º–∞\
--- python‚Äë–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã\
--- –∫–ª–∏–µ–Ω—Ç –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤

------------------------------------------------------------------------

## **7. entrypoint.sh**

–°–∫—Ä–∏–ø—Ç, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è **–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º –±–æ—Ç–∞**:

1.  –ñ–¥—ë—Ç –ø–æ–∫–∞ PostgreSQL —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–º\
2.  –í—ã–ø–æ–ª–Ω—è–µ—Ç `alembic upgrade head`\
3.  –ó–∞–ø—É—Å–∫–∞–µ—Ç –±–æ—Ç (`python -m main`) –∏ –∫—Ä–æ–Ω–¥–∂–æ–±—ã (`python -m cronjobs/main`)

------------------------------------------------------------------------

# –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ Docker

## 1. –°–æ–∑–¥–∞—Ç—å .env-—Ñ–∞–π–ª –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –µ–≥–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –∫–ª—é—á–∞–º–∏

------------------------------------------------------------------------

## 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏ –∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

    docker compose up --build -d

------------------------------------------------------------------------

## 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

    docker compose ps

–û–∂–∏–¥–∞–µ–º—ã–µ —Å–µ—Ä–≤–∏—Å—ã:

-   **postgres_max** --- PostgreSQL
-   **max_bot** --- Telegram‚Äë–±–æ—Ç
-   **max_cron** --- –∫—Ä–æ–Ω‚Äë–ø—Ä–æ—Ü–µ—Å—Å—ã

------------------------------------------------------------------------

## 4. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞—á–∞–ª—å–Ω—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π
    
    docker compose exec bot alembic revision --autogenerate -m "init"
    docker compose exec bot alembic upgrade head

–í–∞–∂–Ω–æ: –ø–∞–ø–∫–∞ `migrations/versions/` –¥–æ–ª–∂–Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å.

------------------------------------------------------------------------

# üõ†Ô∏è –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

  -----------------------------------------------------------------------------------------------------
  –î–µ–π—Å—Ç–≤–∏–µ                            –ö–æ–º–∞–Ω–¥–∞
  ----------------------------------- -----------------------------------------------------------------
  –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã              `docker compose up --build -d`

  –£–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã                  `docker compose down`

  –û—á–∏—Å—Ç–∏—Ç—å —Ç–æ–º–∞                       `docker compose down -v`

  –í–æ–π—Ç–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä                   `docker exec -it max_bot bash`

  –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ë–î                        `docker exec -it postgres_max psql -U max_bot -d max_timetable`

  -----------------------------------------------------------------------------------------------------

------------------------------------------------------------------------
