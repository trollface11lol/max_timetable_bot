# Max Timetable Bot

Телеграм‑бот для получения расписания занятий, подписок на уведомления,
ежедневных рассылок и обработки данных через gRPC‑API.\
Проект поддерживает Docker‑развёртывание, миграции Alembic, крон‑задачи
и интеграцию с PostgreSQL.

------------------------------------------------------------------------

# Структура проекта

    max_timetable_bot/
    │
    ├── alembic.ini                # Конфигурация Alembic
    ├── docker-compose.yml         # Docker‑оркестрация
    ├── Dockerfile                 # Сборка контейнера
    ├── entrypoint.sh              # Точка входа (ожидание БД + миграции + запуск)
    ├── dump.sql                   # Начальный SQL‑дамп для PostgreSQL
    ├── main.py                    # Главный файл запуска Max‑бота
    ├── requirements.txt           # Python‑зависимости
    │
    ├── migrations/                # Alembic миграции
    │   ├── env.py
    │   ├── script.py.mako
    │   └── versions/              # Авто‑генерируемые ревизии
    │
    ├── cronjobs/                  # Крон‑процессы (в отдельном контейнере)
    │   ├── main.py                # Точка входа крон‑сервиса
    │   ├── daily_notifier.py      # Ежедневная рассылка в 8.30 утра с расписанием на день
    │   ├── updates_by_api.py      # Проверка обновлений расписания и рассылка уведомлений
    │   ├── subscribe_by_api.py    # Обновление SQL-файла при наличии более новой версии
    │   └── __init__.py
    │
    ├── handlers/                  # Max‑хендлеры
    │   ├── start_handler.py       # Стартовый хендлер
    │   ├── daily_handler.py       # Управление рассылкой в 8.30 утра
    │   ├── schedule_handler.py    # Хендлер, показывающий все подписки текущего чата
    │   ├── days_handler.py        # Показ расписания на сегодня / завтра / неделю
    │   ├── subscribe_handler.py   # Подписка на выбранный тип
    │   ├── unsubscribe_handler.py # Отписка от выбранного типа
    │   └── __init__.py
    │
    ├── db/                        # БД‑логика
    │   ├── db_tables.py           # SQLAlchemy модели
    │   ├── db_operations.py       # Операции с БД
    │   ├── schedule-min-3.db      # Локальный SQLite
    │
    ├── grpc/                      # gRPC интерфейсы
    │   ├── personal-schedule.proto
    │   ├── personal_schedule_pb2.py
    │   ├── personal_schedule_pb2_grpc.py
    │   ├── schedule_client.py
    │
    └── utils/                     # Вспомогательные файлы
        ├── detect.py              # Функция на определения типа подписки
        ├── keyboards.py           # Инлайн-клавиатуры
        ├── messaging.py           # Отправка сообщений в чат через HTTP
        └── __init__.py

------------------------------------------------------------------------

# Описание основных компонентов

## **1. main.py**

Основной процесс Max‑бота:\
--- инициализация maxapi\
--- загрузка хендлеров\
--- запуск polling

------------------------------------------------------------------------

## **2. handlers/**

Каталог обработчиков Max‑команд:

  -------------------------------------------------------------------------
  `start_handler.py`         Команда /start

  `schedule_handler.py`      Вывод всех имеющихся подписок у текущего чата

  `subscribe_handler.py`     Подписка на выбранное расписание

  `unsubscribe_handler.py`   Отписка от выбранного расписания

  `daily_handler.py`         Управление ежедневными уведомлениями в 8.30 утра

  `days_handler.py`          Запрос расписания на день / завтра / неделю

------------------------------------------------------------------------

## **3. cronjobs/**

Отдельный контейнер, выполняющий периодические задачи:

  -----------------------------------------------------------------------
  `daily_notifier.py`     Ежедневная рассылка расписания на сегодня в 8.30 утра

  `updates_by_api.py`     Проверка обновлений расписания по API и рассылка
                          уведомлений с изменениями

  `subscribe_by_api.py`   Автоматическая подписка новых пользователей
                          через API

  `main.py`               Запуск всех кронджобов по расписанию

------------------------------------------------------------------------

## **4. db/**

Логика работы PostgreSQL и SQLite:

  ----------------------- -----------------------------------------------
  `db_tables.py`          SQLAlchemy‑модели для хранения подписок, 
                          согласий на рассылки, и текущей версии 
                          расписания (`max_subscribes`, `snapshot_info`)

  `db_operations.py`      Функции по работе с БД

  `schedule-min-3.db`     Локальный SQLite с расписанием

------------------------------------------------------------------------

## **5. migrations/**

Alembic‑миграции для PostgreSQL.

При запуске, после поднятия Docker:

    docker compose exec bot alembic revision --autogenerate -m "init"
    docker compose exec bot alembic upgrade head

Создаются таблицы:

-   `max_subscribes`
-   `snapshot_info`

------------------------------------------------------------------------

## **6. grpc/**

gRPC‑клиент для получения актуального расписания:\
--- protobuf схема\
--- python‑генераторы\
--- клиент для запросов

------------------------------------------------------------------------

## **7. entrypoint.sh**

Скрипт, который запускается **в контейнере перед стартом бота**:

1.  Ждёт пока PostgreSQL станет доступным\
2.  Выполняет `alembic upgrade head`\
3.  Запускает бот (`python -m main`) и кронджобы (`python -m cronjobs/main`)

------------------------------------------------------------------------

# Локальный запуск через Docker

## 1. Переименовать .env.tmpl в .env и заполнить его необходимыми ключами

------------------------------------------------------------------------

## 2. Установка зависимостей и запуск контейнеров

    docker compose up --build -d

------------------------------------------------------------------------

## 3. Проверить состояние контейнеров

    docker compose ps

Ожидаемые сервисы:

-   **postgres_max** --- PostgreSQL
-   **max_bot** --- Telegram‑бот
-   **max_cron** --- крон‑процессы

------------------------------------------------------------------------

## 4. Генерация начальных миграций
    
    docker compose exec bot alembic revision --autogenerate -m "init"
    docker compose exec bot alembic upgrade head

Важно: папка `migrations/versions/` должна существовать.

------------------------------------------------------------------------

# Полезные команды

  ----------------------------------- -----------------------------------------------------------------
  Пересобрать контейнеры              `docker compose up --build -d`

  Удалить контейнеры                  `docker compose down`

  Очистить тома                       `docker compose down -v`

  Войти в контейнер                   `docker exec -it max_bot bash`

  Проверить БД                        `docker exec -it postgres_max psql -U max_bot -d max_timetable`

  -----------------------------------------------------------------------------------------------------

# Вклад участников

### Автор идеи
- Бородкин Федор

### Backend
- Бородкин Федор — разработка основного backend-функционала, интеграция gRPC, работа с .proto, развёртывание сервисов, создание и поддержка API-клиента, реализация бизнес-логики.
- Зелякин Михаил — оптимизация API-запросов, улучшение структуры клиента, рефакторинг вспомогательных модулей.
- Фролова Софья — тестирование gRPC-методов, проверка корректности ответов и обработки ошибок.

### Cron
- Бородкин Федор - разработка и реализация cron-задач (ежедневные уведомления, обновления данных, подписки), настройка расписаний, логики и интеграций.
- Зелякин Михаил — оптимизация логирования и мониторинга выполнения задач.

### Max_bot
- Бородкин Федор - полный цикл разработки Telegram-бота: хендлеры, состояние, маршрутизация, подписки, уведомления, интеграции с backend и cron, обработка расписания.

### Контроль регламента
- Фролова Софья - контроль соблюдения правил хакатона, дедлайнов, корректности отправки итоговых материалов; проверка форматов сдачи проекта, соответствия требованиям организаторов, сроков выкладки, правильности структурирования презентации/репозитория.

### Тестирование
- Бородкин Федор - функциональное тестирование бота, cron-задач и интеграции с backend.
- Зелякин Михаил - тестирование API-клиента.
- Фролова Софья - тестирование пользовательских сценариев.

---

# Тестирование

| № | Функциональность | Сценарий | Ожидаемый результат | Фактический результат | Статус |
|---|------------------|----------|---------------------|------------------------|--------|
| 1 | Подписка | Подтверждение подписки | Сохраняется | Сохранилось | ✔ |
| 2 | Расписание | Запрос расписания | Корректный вывод | Работает | ✔ |
| 3 | Ежедневные уведомления | Уведомление в нужное время | Приходит | Приходит | ✔ |
| 4 | Обновление API | Cron обновляет данные | Нет дублей | Всё корректно | ✔ |
| 5 | Проверка подписок | 3 подписки | Все корректно | Да | ✔ |
| 6 | Пустые дни | Нет занятий | Сообщение «нет занятий» | Да | ✔ |
| 7 | gRPC | Проверка данных | Строго по proto | Да | ✔ |
| 8 | Отписка | Удаление | Удаляется | Да | ✔ |

------------------------------------------------------------------------
